<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –≤—ã—Å—Ç—É–ø–∞—é—â–∏—Ö</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
    <div class="container" id="appContainer">
        <!-- –ó–∞–≥–ª—É—à–∫–∞: –æ–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è -->
        <div id="waitingScreen" class="hidden">
            <div class="placeholder">
                <div class="placeholder-title">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ</div>
                <p>–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞ –Ω–µ –Ω–∞—á–∞–ª–æ—Å—å.<br>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.</p>
            </div>
        </div>

        <!-- –ó–∞–≥–ª—É—à–∫–∞: –æ–∂–∏–¥–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ -->
        <div id="nextParticipantScreen" class="hidden">
            <div class="placeholder">
                <div class="placeholder-title">‚è∏Ô∏è –ü–∞—É–∑–∞</div>
                <p>–û–∂–∏–¥–∞–µ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞.<br>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.</p>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è -->
        <div id="votingScreen" class="hidden">
            <div class="speaker-number" id="speakerNumber">1</div>
            <div class="description" id="speakerDescription"></div>

            <div class="stars-container" id="starsContainer">
                <span class="star" data-rating="1">‚òÖ</span>
                <span class="star" data-rating="2">‚òÖ</span>
                <span class="star" data-rating="3">‚òÖ</span>
                <span class="star" data-rating="4">‚òÖ</span>
                <span class="star" data-rating="5">‚òÖ</span>
            </div>

            <div class="buttons-container">
                <button class="vote-again-btn" id="voteAgainBtn">–ì–æ–ª–æ—Å–æ–≤–∞—Ç—å –µ—â—ë</button>
                <button class="next-btn" id="nextBtn">–î–∞–ª–µ–µ</button>
            </div>

            <div class="voter-number" id="voterNumber">–ì–æ–ª–æ—Å—É—é—â–∏–π ‚Ññ1</div>
            <div id="errorMessage" class="error-message hidden"></div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div id="resultsScreen" class="hidden">
            <div class="results-title">üèÜ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è</div>
            <div class="results-container" id="resultsContainer"></div>
        </div>
    </div>

    <script>
        $(() => {
            // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
            const API_BASE_URL = window.location.origin + '/api'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ—Ñ–∏–∫—Å /api/
            const POLLING_INTERVAL = 500;

            // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            let currentState = 'WAITING';
            let currentPersonNum = 0;
            let currentDescription = '';
            let selectedRating = 0;
            let voterCount = 1;
            let pollingTimer = null;
            let firstVoterHasVoted = false; // –§–ª–∞–≥: –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª –ª–∏ –ø–µ—Ä–≤—ã–π –≥–æ–ª–æ—Å—É—é—â–∏–π

            // –≠–ª–µ–º–µ–Ω—Ç—ã DOM (jQuery)
            const $screens = {
                waiting: $('#waitingScreen'),
                nextParticipant: $('#nextParticipantScreen'),
                voting: $('#votingScreen'),
                results: $('#resultsScreen')
            };

            const $speakerNumber = $('#speakerNumber');
            const $speakerDescription = $('#speakerDescription');
            const $starsContainer = $('#starsContainer');
            const $stars = $('.star');
            const $voteAgainBtn = $('#voteAgainBtn');
            const $nextBtn = $('#nextBtn');
            const $voterNumber = $('#voterNumber');
            const $errorMessage = $('#errorMessage');
            const $resultsContainer = $('#resultsContainer');

            // ============ API —Ñ—É–Ω–∫—Ü–∏–∏ ============

            async function fetchStatus() {
                try {
                    return await $.get(`${API_BASE_URL}/status`);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Å—Ç–∞—Ç—É—Å–∞:', error);
                    return null;
                }
            }

            async function submitVote(personnum, rating) {
                try {
                    await $.post(`${API_BASE_URL}/vote?personnum=${personnum}&rating=${rating}`);
                    return { status: 200 };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≥–æ–ª–æ—Å–∞:', error);
                    return null;
                }
            }

            async function fetchResults() {
                try {
                    return await $.get(`${API_BASE_URL}/getresults`);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', error);
                    return [];
                }
            }

            // ============ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞–º–∏ ============

            function showScreen(screenName) {
                $.each($screens, (name, $screen) => $screen.addClass('hidden'));
                
                const screenMap = {
                    'WAITING': $screens.waiting,
                    'VOTING': $screens.voting,
                    'NEXT_PARTICIPANT': $screens.nextParticipant,
                    'RESULTS': $screens.results
                };
                
                screenMap[screenName]?.removeClass('hidden');
            }

            // ============ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ ============

            async function handleStatusUpdate() {
                const status = await fetchStatus();
                if (!status) return;

                if (status.status === 'VOTING_NOT_STARTED') {
                    currentState = 'WAITING';
                    showScreen('WAITING');
                }
                else if (status.status === 'VOTING_FINISHED') {
                    currentState = 'RESULTS';
                    stopPolling();
                    await showResults();
                }
                else if (status.status === 'VOTING') {
                    if (currentState === 'NEXT_PARTICIPANT') {
                        if (status.personnum > currentPersonNum) {
                            startVoting(status.personnum, status.description);
                        }
                    } else if (currentState !== 'VOTING' || status.personnum !== currentPersonNum) {
                        startVoting(status.personnum, status.description);
                    }
                }
            }

            function startVoting(personnum, description) {
                currentState = 'VOTING';
                currentPersonNum = personnum;
                currentDescription = description;

                $speakerNumber.text(personnum);
                $speakerDescription.text(description);

                selectedRating = 0;
                voterCount = 1;
                firstVoterHasVoted = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–∏ –Ω–æ–≤–æ–º —É—á–∞—Å—Ç–Ω–∏–∫–µ
                updateStars(0);
                $voterNumber.text('–ì–æ–ª–æ—Å—É—é—â–∏–π ‚Ññ1');
                $nextBtn.prop('disabled', true); // –ü–µ—Ä–≤—ã–π –≥–æ–ª–æ—Å—É—é—â–∏–π –û–ë–Ø–ó–ê–ù –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å
                $voteAgainBtn.prop('disabled', true);
                hideError();

                showScreen('VOTING');
            }

            async function showResults() {
                const results = await fetchResults();
                $resultsContainer.empty();

                if (results.length === 0) {
                    $resultsContainer.html('<div class="placeholder">–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è</div>');
                } else {
                    results.forEach((result, index) => {
                        const $item = $(`
                            <div class="result-item">
                                <div class="result-rank">${index + 1}</div>
                                <div class="result-info">
                                    <div class="result-description">${result.description}</div>
                                    <div class="result-personnum">–£—á–∞—Å—Ç–Ω–∏–∫ ‚Ññ${result.personnum}</div>
                                </div>
                                <div class="result-rating">‚òÖ ${result.rating}</div>
                            </div>
                        `);
                        $resultsContainer.append($item);
                    });
                }

                showScreen('RESULTS');
            }

            // ============ Polling ============

            function startPolling() {
                if (pollingTimer) return;
                handleStatusUpdate();
                pollingTimer = setInterval(handleStatusUpdate, POLLING_INTERVAL);
            }

            function stopPolling() {
                if (pollingTimer) {
                    clearInterval(pollingTimer);
                    pollingTimer = null;
                }
            }

            // ============ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–≤—ë–∑–¥ ============

            function highlightStars(rating) {
                $stars.each((index, star) => {
                    $(star).toggleClass('active', index < rating);
                });
            }

            function updateStars(rating) {
                highlightStars(rating);
            }

            function flashStars(rating) {
                $stars.each((index, star) => {
                    if (index < rating) {
                        const $star = $(star);
                        $star.addClass('flash');
                        setTimeout(() => $star.removeClass('flash'), 600);
                    }
                });
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∑–≤—ë–∑–¥
            $stars.on('click', function() {
                const rating = parseInt($(this).data('rating'));
                selectedRating = rating;
                updateStars(rating);
                flashStars(rating);
                
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –æ–±–µ –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –æ—Ü–µ–Ω–∫–∏
                $nextBtn.prop('disabled', false);
                $voteAgainBtn.prop('disabled', false);
            });

            $stars.on('mouseenter', function() {
                const rating = parseInt($(this).data('rating'));
                highlightStars(rating);
            });

            $starsContainer.on('mouseleave', () => updateStars(selectedRating));

            // ============ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ ============

            $voteAgainBtn.on('click', async () => {
                if (selectedRating === 0) return;

                const response = await submitVote(currentPersonNum, selectedRating);
                if (!response || response.status !== 200) {
                    showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≥–æ–ª–æ—Å–∞');
                    return;
                }

                hideError();
                
                // –û—Ç–º–µ—á–∞–µ–º, —á—Ç–æ –ø–µ—Ä–≤—ã–π –≥–æ–ª–æ—Å—É—é—â–∏–π –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª (–µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª –æ–Ω)
                if (voterCount === 1) {
                    firstVoterHasVoted = true;
                }
                
                selectedRating = 0;
                updateStars(0);
                voterCount++;
                $voterNumber.text(`–ì–æ–ª–æ—Å—É—é—â–∏–π ‚Ññ${voterCount}`);
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º "–ì–æ–ª–æ—Å–æ–≤–∞—Ç—å –µ—â—ë" –¥–æ –Ω–æ–≤–æ–≥–æ –≤—ã–±–æ—Ä–∞
                $voteAgainBtn.prop('disabled', true);
                
                // "–î–∞–ª–µ–µ" –æ—Å—Ç–∞—ë—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω–æ–π, –µ—Å–ª–∏ –ø–µ—Ä–≤—ã–π –≥–æ–ª–æ—Å—É—é—â–∏–π –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª
                $nextBtn.prop('disabled', !firstVoterHasVoted);
            });

            $nextBtn.on('click', async () => {
                // –ï—Å–ª–∏ –Ω–∏–∫—Ç–æ –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª - –Ω–µ –¥–∞—ë–º –ø–µ—Ä–µ–π—Ç–∏ –¥–∞–ª—å—à–µ
                if (selectedRating === 0 && !firstVoterHasVoted) return;

                // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ—ë
                if (selectedRating > 0) {
                    const response = await submitVote(currentPersonNum, selectedRating);
                    if (!response || response.status !== 200) {
                        showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≥–æ–ª–æ—Å–∞');
                        return;
                    }
                }

                hideError();
                currentState = 'NEXT_PARTICIPANT';
                showScreen('NEXT_PARTICIPANT');
            });

            // ============ –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ============

            function showError(message) {
                $errorMessage.text(message).removeClass('hidden');
            }

            function hideError() {
                $errorMessage.addClass('hidden');
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            $nextBtn.prop('disabled', true);
            $voteAgainBtn.prop('disabled', true);
            startPolling();
        });
    </script>
</body>
</html>
