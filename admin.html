<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleVote - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="admin.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
<div class="container">
    <h1>üéØ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
    <p class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ–º SimpleVote</p>

    <!-- –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å -->
    <div class="status-section">
        <div class="status-label">–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å</div>
        <div class="status-value" id="statusText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div id="currentInfo"></div>
    </div>

    <!-- –§–æ—Ä–º–∞ –∑–∞–ø—É—Å–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è -->
    <div class="form-group">
        <label for="participantName">–ò–º—è / –æ–ø–∏—Å–∞–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞</label>
        <input 
            type="text" 
            id="participantName" 
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"
        >
    </div>

    <button class="btn-start" id="btnStart">
        ‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞
    </button>

    <button class="btn-finish" id="btnFinish">
        ‚èπÔ∏è –ó–∞–≤–µ—Ä—à–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
    </button>

    <button class="btn-results" id="btnRestart">
        üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
    </button>

    <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="messageArea"></div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div id="resultsArea" class="hidden"></div>
</div>

<script>
    $(() => {
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
        const API_BASE_URL = window.location.origin + '/api'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ—Ñ–∏–∫—Å /api/

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM (jQuery)
        const $statusText = $('#statusText');
        const $currentInfo = $('#currentInfo');
        const $statusSection = $('.status-section');
        const $formGroup = $('.form-group');
        const $btnStart = $('#btnStart');
        const $btnFinish = $('#btnFinish');
        const $btnRestart = $('#btnRestart');
        const $messageArea = $('#messageArea');
        const $resultsArea = $('#resultsArea');
        const $participantName = $('#participantName');

        // ============ API —Ñ—É–Ω–∫—Ü–∏–∏ ============

        // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å
        async function fetchStatus() {
            try {
                const data = await $.get(`${API_BASE_URL}/status`);
                updateStatusDisplay(data);
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatusDisplay(data) {
            if (data.status === 'VOTING_NOT_STARTED') {
                $statusText.html('–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞—á–∞—Ç–æ <span class="status-badge waiting">–û–∂–∏–¥–∞–Ω–∏–µ</span>');
                $currentInfo.html('');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                $statusSection.show();
                $formGroup.show();
                $btnStart.show();
                $btnFinish.show();
                $btnRestart.show();
                $resultsArea.addClass('hidden');
            } 
            else if (data.status === 'VOTING') {
                $statusText.html('–ò–¥—ë—Ç –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ <span class="status-badge voting">–ê–∫—Ç–∏–≤–Ω–æ</span>');
                $currentInfo.html(`
                    <div style="margin-top: 10px;">
                        <div style="font-size: 14px; color: #666;">–£—á–∞—Å—Ç–Ω–∏–∫ ‚Ññ${data.personnum}</div>
                        <div style="font-size: 16px; font-weight: 600; color: #333;">${data.description}</div>
                    </div>
                `);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                $statusSection.show();
                $formGroup.show();
                $btnStart.show();
                $btnFinish.show();
                $btnRestart.show();
                $resultsArea.addClass('hidden');
            }
            else if (data.status === 'VOTING_FINISHED') {
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –∫—Ä–æ–º–µ "–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ"
                $statusSection.hide();
                $formGroup.hide();
                $btnStart.hide();
                $btnFinish.hide();
                $btnRestart.show(); // –û—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞ –≤–∏–¥–∏–º–æ–π
                $messageArea.html('');
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                showResults();
            }
        }

        // –ù–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        async function startVoting() {
            const name = $participantName.val().trim();
            
            if (!name) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ –∏–º—è/–æ–ø–∏—Å–∞–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞', 'error');
                return;
            }

            try {
                const data = await $.post(
                    `${API_BASE_URL}/setcurrentperson?description=${encodeURIComponent(name)}`
                );
                
                if (data.success) {
                    showMessage(`‚úÖ –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ –¥–ª—è: ${name}`, 'success');
                    $participantName.val('');
                    fetchStatus();
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è', 'error');
            }
        }

        // –ó–∞–≤–µ—Ä—à–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
        async function finishVoting() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ?')) {
                return;
            }

            try {
                const data = await $.post(
                    `${API_BASE_URL}/setcurrentperson?description=VOTING_FINISHED`
                );
                
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∂–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    fetchStatus();
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è', 'error');
            }
        }

        // –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
        async function restartVoting() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ? –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) {
                return;
            }

            try {
                const data = await $.post(
                    `${API_BASE_URL}/setcurrentperson?description=VOTING_RESTART`
                );
                
                if (data.success) {
                    showMessage('‚úÖ –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ. –ú–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å –∑–∞–Ω–æ–≤–æ!', 'success');
                    fetchStatus();
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è', 'error');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        async function showResults() {
            try {
                const results = await $.get(`${API_BASE_URL}/getresults`);
                $resultsArea.removeClass('hidden');
                
                if (results.length === 0) {
                    $resultsArea.html('<div class="message">–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</div>');
                } else {
                    let html = '<h2 style="color: #667eea; margin: 30px 0 20px;">üèÜ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2><div class="results-list">';
                    
                    results.forEach((result, index) => {
                        html += `
                            <div class="result-item">
                                <div class="result-rank">${index + 1}</div>
                                <div class="result-info">
                                    <div class="result-description">${result.description}</div>
                                    <div class="result-personnum">–£—á–∞—Å—Ç–Ω–∏–∫ ‚Ññ${result.personnum}</div>
                                </div>
                                <div class="result-rating">‚≠ê ${result.rating}</div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    $resultsArea.html(html);
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤', 'error');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(text, type) {
            $messageArea.html(`<div class="message ${type}">${text}</div>`);
            setTimeout(() => $messageArea.html(''), 5000);
        }

        // ============ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ============

        // –ö–Ω–æ–ø–∫–∞ "–ù–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ"
        $btnStart.on('click', startVoting);

        // –ö–Ω–æ–ø–∫–∞ "–ó–∞–≤–µ—Ä—à–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ"
        $btnFinish.on('click', finishVoting);

        // –ö–Ω–æ–ø–∫–∞ "–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ"
        $btnRestart.on('click', restartVoting);

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        $participantName.on('keypress', (e) => {
            if (e.key === 'Enter') startVoting();
        });

        // ============ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ============

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
        setInterval(fetchStatus, 2000);

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        fetchStatus();
    });
</script>
</body>
</html>
